---
title: "tanks"
author: "Daniel Suh"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
---

packages
```{r, message = F}
library(tidyverse)
library(magrittr)
library(here)
library(ggnewscale)
library(lubridate)
library(epitools)
library(pracma)
```

read data
```{r read data, message = F}
readRDS(here("data", "processed_data", "abundance.rds"))
readRDS(here("data", "processed_data", "infections.rds"))
readRDS(here("data", "processed_data", "summ_abund.rds"))
readRDS(here("data", "processed_data", "summ_inf.rds"))
readRDS(here("data", "processed_data", "summ_ysi.rds"))
```




# *Zoop Data*

Totals
```{r}
ggplot(data,aes(x=sample_date,y=total, color=temp))+ geom_point() + geom_line(aes(group = bucket)) + scale_color_discrete() + theme(legend.position = "none") + facet_wrap(vars(community)) 

ggplot(data,aes(x=sample_date,y=daphnia, color=temp))+ geom_point() + geom_line(aes(group = bucket)) + scale_color_discrete() +  facet_wrap(vars(community)) 

ggplot(data,aes(x=sample_date,y=cerio, color=temp))+ geom_point() + geom_line(aes(group = bucket)) + scale_color_discrete() + facet_wrap(vars(community)) 

```

```{r}
ggplot(data,aes(x=sample_date,y=total, color=temp))+ geom_point() + geom_line(aes(group = bucket)) + scale_color_discrete() + theme(legend.position = "none") + facet_grid(rows= vars(temp), cols = vars(community)) 

ggplot(data,aes(x=sample_date,y=daphnia, color=temp))+ geom_point() + geom_line(aes(group = bucket)) + scale_color_discrete() + facet_grid(rows= vars(temp), cols = vars(community)) 

ggplot(data,aes(x=sample_date,y=cerio, color=temp))+ geom_point() + geom_line(aes(group = bucket)) + scale_color_discrete() + facet_grid(rows= vars(temp), cols = vars(community)) 

```




```{r}
ggplot(summary, aes(x=sample_date,y=mean_total, color = temp)) + 
  geom_point() + 
  geom_line(aes(group=treatment)) + 
  geom_errorbar(aes(ymin = mean_total-total_se, ymax = mean_total+total_se)) +
  facet_grid(rows = vars(temp), cols = vars(community)) + 
  labs(title = "Average abundance over time")

ggplot(summary, aes(x=sample_date,y=mean_daphnia, color = temp)) + 
  geom_point() + 
  geom_line(aes(group=treatment)) + 
  geom_errorbar(aes(ymin = mean_daphnia-daphnia_se, ymax = mean_daphnia+daphnia_se)) +
  facet_grid(rows = vars(temp), cols = vars(community))  + 
  labs(title = "Average daphnia abundance over time")

ggplot(summary, aes(x=sample_date,y=mean_cerio, color = temp)) + 
  geom_point() + 
  geom_line(aes(group=treatment)) + 
  geom_errorbar(aes(ymin = mean_cerio-cerio_se, ymax = mean_cerio+cerio_se)) +
  facet_grid(rows = vars(temp), cols = vars(community))  + 
  labs(title = "Average ceriodaphnia abundance over time")
```



```{r}
size_ratio %>% filter(community %in% c("D", "DCM", "DM")) %>% ggplot(., aes(x=sample_date, y=j_ratio, color = temp)) + geom_point() + geom_line(aes(group=bucket)) + facet_grid(rows= vars(temp), cols = vars(community)) + labs(y = "Percent juvenile")
```

```{r}
size_ratio_summ <- size_ratio %>% group_by(treatment, sample_date) %>% summarize(mean_perc = mean(j_ratio), temp = temp)

#ggplot(size_ratio_summ, aes(x=sample_date, y=j_ratio, color = temp)) + geom_point()
```




Incidence (i.e. positive case counts)
should na.rm be set to true? If there is an NA, then that means that at that sample that there were no individuals found (denominator = 0) when measuring incidence
Is this a significant measurement or not? Should it be counted as true zero or just ommitted?




```{r}
mean_inc %>% ggplot(.,aes(x=sample_date, y=mean_inc, color = temp)) + geom_point() + 
  geom_line(aes(group=treatment)) + 
  geom_errorbar(aes(ymin = mean_inc-inc_se, ymax = mean_inc+inc_se)) +
  facet_grid(rows = vars(temp), cols = vars(community)) + labs(title="Total (Daphnia + Cerio) Incidence over Time")

mean_inc %>% ggplot(.,aes(x=sample_date, y=mean_daph_inc, color = temp)) + geom_point() + 
  geom_line(aes(group=treatment)) + 
  geom_errorbar(aes(ymin = mean_daph_inc-daph_inc_se, ymax = mean_daph_inc+daph_inc_se)) +
  facet_grid(rows = vars(temp), cols = vars(community))  + labs(title="Daphnia Incidence over Time")

mean_inc %>% ggplot(.,aes(x=sample_date, y=mean_cer_inc, color = temp)) + geom_point() + 
  geom_line(aes(group=treatment)) + 
  geom_errorbar(aes(ymin = mean_cer_inc-cer_inc_se, ymax = mean_cer_inc+cer_inc_se)) +
  facet_grid(rows = vars(temp), cols = vars(community))  + labs(title="Cerio Incidence over Time")
```





# *YSI DATA*

ysi



temp
```{r}
# ggplot(ysi_summ, aes(x=Date, y=temp_c, color = bucket)) + geom_point() + geom_line(aes(group=bucket)) + scale_color_discrete() + theme(legend.position = "none")

ggplot(ysi_summ, aes(x=Date, y=temp_c, color = temp)) + geom_point() + geom_line(aes(group=bucket)) + scale_color_discrete() + facet_grid(rows=vars(temp), cols = vars(community))
```

```{r}
ysi_summ %>% filter(pool == 7) %>% ggplot(., aes(x=Date, y=temp_c, color = bucket)) + geom_point() + geom_line(aes(group=bucket)) + scale_color_discrete() + theme(legend.position = "none")
```

do_per
```{r}
# ggplot(ysi_summ, aes(x=Date, y=do_per, color = community)) + geom_point() + geom_line(aes(group=bucket)) + scale_color_discrete() + facet_wrap(vars(temp))
# 
# ggplot(ysi_summ, aes(x=Date, y=do_per, color = temp)) + geom_point() + geom_line(aes(group=bucket)) + scale_color_discrete() + facet_wrap(vars(community))

ggplot(ysi_summ, aes(x=Date, y=do_per, color = temp)) + geom_point() + geom_line(aes(group=bucket)) + scale_color_discrete() + facet_grid(rows=vars(temp), cols = vars(community))
```

ph
```{r}
# ggplot(ysi_summ, aes(x=Date, y=ph, color = community)) + geom_point() + geom_line(aes(group=bucket)) + scale_color_discrete() + facet_wrap(vars(temp))
# 
# ggplot(ysi_summ, aes(x=Date, y=ph, color = temp)) + geom_point() + geom_line(aes(group=bucket)) + scale_color_discrete() + facet_wrap(vars(community))

ggplot(ysi_summ, aes(x=Date, y=ph, color = temp)) + geom_point() + geom_line(aes(group=bucket)) + scale_color_discrete() + facet_grid(rows=vars(temp), cols = vars(community))
```

chlor_conc
```{r}
# ggplot(ysi_summ, aes(x=Date, y=chlor_conc, color = community)) + geom_point() + geom_line(aes(group=bucket)) + scale_color_discrete() +  facet_wrap(vars(temp))
# 
# ggplot(ysi_summ, aes(x=Date, y=chlor_conc, color = temp)) + geom_point() + geom_line(aes(group=bucket)) + scale_color_discrete() +  facet_wrap(vars(community))

ggplot(ysi_summ, aes(x=Date, y=chlor_conc, color = temp)) + geom_point() + geom_line(aes(group=bucket)) + scale_color_discrete() + facet_grid(rows=vars(temp), cols = vars(community))
```
according to temp
```{r}
ggplot(ysi_summ, aes(x=Date, y=temp_c, color = temp)) + geom_point() + geom_line(aes(group=bucket)) + scale_color_discrete() + facet_grid(rows=vars(temp), cols = vars(community))


ggplot(ysi_summ, aes(x=Date, y=do_per, color = temp)) + geom_point() + geom_line(aes(group=bucket)) + scale_color_discrete() + facet_grid(rows=vars(temp), cols = vars(community))

ggplot(ysi_summ, aes(x=Date, y=ph_mv, color = temp)) + geom_point() + geom_line(aes(group=bucket)) + scale_color_discrete() + facet_grid(rows=vars(temp), cols = vars(community))

ggplot(ysi_summ, aes(x=Date, y=ph, color = temp)) + geom_point() + geom_line(aes(group=bucket)) + scale_color_discrete() + facet_grid(rows=vars(temp), cols = vars(community))

ggplot(ysi_summ, aes(x=Date, y=chlor_conc, color = temp)) + geom_point() + geom_line(aes(group=bucket)) + scale_color_discrete() + facet_grid(rows=vars(temp), cols = vars(community))

ggplot(ysi_summ, aes(x=Date, y=chlor_rfu, color = temp)) + geom_point() + geom_line(aes(group=bucket)) + scale_color_discrete() + facet_grid(rows=vars(temp), cols = vars(community))
```

according to pool
```{r}

ggplot(ysi_summ, aes(x=Date, y=temp_c, color = temp)) + geom_point() + geom_line(aes(group=bucket)) + scale_color_discrete() + facet_grid(rows=vars(pool), cols = vars(community))


ggplot(ysi_summ, aes(x=Date, y=do_per, color = temp)) + geom_point() + geom_line(aes(group=bucket)) + scale_color_discrete() + facet_grid(rows=vars(pool), cols = vars(community))

ggplot(ysi_summ, aes(x=Date, y=ph, color = temp)) + geom_point() + geom_line(aes(group=bucket)) + scale_color_discrete() + facet_grid(rows=vars(pool), cols = vars(community))


ggplot(ysi_summ, aes(x=Date, y=chlor_conc, color = temp)) + geom_point() + geom_line(aes(group=bucket)) + scale_color_discrete() + facet_grid(rows=vars(pool), cols = vars(community))

```



# Metsch Infections in Daphnia across Temp

```{r}
summary %>% filter(community %in% c("D","DM")) %>% ggplot(., aes(x=sample_date,y=mean_daphnia, color = temp)) + 
  geom_point() + 
  geom_line(aes(group=treatment)) + 
  geom_errorbar(aes(ymin = mean_daphnia-daphnia_se, ymax = mean_daphnia+daphnia_se)) +
  facet_grid(rows = vars(temp), cols = vars(community)) +
  theme(axis.text.x = element_text(angle = 60, vjust = 1, hjust = 1)) + 
  labs(title = "Average Daphnia abundance over time")

summary %>% filter(community %in% c("D","DM")) %>% ggplot(., aes(x=sample_date,y=mean_daphnia, color = temp)) + 
  geom_point() + 
  geom_line(aes(group=treatment)) + 
  geom_errorbar(aes(ymin = mean_daphnia-daphnia_se, ymax = mean_daphnia+daphnia_se)) +
  facet_grid(rows = vars(community), cols = vars(temp)) +
  theme(axis.text.x = element_text(angle = 60, vjust = 1, hjust = 1)) + 
  labs(title = "Average Daphnia abundance over time")

```

```{r}
mean_inc %>% filter(community %in% c("DM")) %>% ggplot(.,aes(x=sample_date, y=mean_inc, color = temp)) + geom_point() + 
  geom_line(aes(group=treatment)) + 
  geom_errorbar(aes(ymin = mean_inc-inc_se, ymax = mean_inc+inc_se)) +
  facet_grid(rows = vars(temp), cols = vars(community)) +
  theme(axis.text.x = element_text(angle = 60, vjust = 1, hjust = 1))

```

Let's look at Infection Prevalence in Daphnia over temperatures for daphnia and ceriodaphnia treatments

```{r}
prev_summary <- data %>% 
  group_by(treatment, sample_date, temp, community) %>%
  summarize(n = n(),
            daph_prev = mean(daphnia_prev),
            cerio_prev = mean(cerio_prev),
            total_prev = mean(total_prev))
```

```{r}
prev_summary %>% filter(community %in% c("CM", "DCM", "DM")) %>% ggplot(.,aes(x=sample_date, y=daph_prev, color = temp)) + geom_point() + 
  geom_line(aes(group=treatment)) + 
  facet_grid(rows = vars(temp), cols = vars(community)) +
  theme(axis.text.x = element_text(angle = 60, vjust = 1, hjust = 1)) + labs(title = "Daphnia prevalence over time")


prev_summary %>% filter(community %in% c("CM", "DCM", "DM")) %>% ggplot(.,aes(x=sample_date, y=daph_prev, color = temp)) + geom_point() + 
  geom_line(aes(group=treatment)) + 
  facet_grid(cols = vars(temp), rows = vars(community)) +
  theme(axis.text.x = element_text(angle = 60, vjust = 1, hjust = 1)) + labs(title = "Daphnia prevalence over time")


prev_summary %>% filter(community %in% c("CM", "DCM", "DM")) %>% ggplot(.,aes(x=sample_date, y=cerio_prev, color = temp)) + geom_point() + 
  geom_line(aes(group=treatment)) + 
  facet_grid(rows = vars(temp), cols = vars(community)) +
  theme(axis.text.x = element_text(angle = 60, vjust = 1, hjust = 1)) + labs(title = "Cerioaphnia prevalence over time")


prev_summary %>% filter(community %in% c("CM", "DCM", "DM")) %>% ggplot(.,aes(x=sample_date, y=total_prev, color = temp)) + geom_point() + 
  geom_line(aes(group=treatment)) + 
  facet_grid(rows = vars(temp), cols = vars(community)) +
  theme(axis.text.x = element_text(angle = 60, vjust = 1, hjust = 1)) + labs(title = "Daphnia+Cerio prevalence over time")
```

In terms of prevalence, daphnia had larger epidemics in the presence of ceriodaphnia rather than not but there weren't that many ceriodaphnia anyways. We need to look at what the treaments actually ended up being since we can't really trust how we set them up to be. One interesting thing is that the timing of epidemics for daphnia only treaments seemed to always be earlier than daphnia+cerio treatments. 


Epidemiological characteristics to look at
 - Maximum prevalence
 - severity (sign and size of standardized regression coefficients)
 - timing of start and peak prevalence
 - integral of infection prevalence

```{r}
prev_summary %<>% mutate(time = as.numeric(sample_date-start_date))

prev_auc <- prev_summary %>% group_by(treatment) %>% summarize(daph_auc = trapz(x = time, y = daph_prev),
                                                   cerio_auc = trapz(x = time, y = cerio_prev),
                                                   total_auc = trapz(x = time, y = total_prev))
```


